<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ›’ Ø§Ù„Ù…ØªØ¬Ø± Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·</title>
<style>
.header-logo,.sidebar,.search-form,.dark-toggle,.top-bar,header,#header-wrapper,footer,.footer-container,#footer-wrapper{display:none !important;}
body { font-family: Arial, sans-serif; background: #f0f0f0; direction: rtl; margin: 0; padding-bottom: 80px; }
.store { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; max-width: 900px; margin: 0 auto; padding: 10px; }
.product { background: #fff; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1); padding: 10px; text-align: center; }
.product img { width: 100%; height: 90px; object-fit: contain; padding: 5px; background: #fff; }
.product h3 { margin: 5px 0; font-size: 0.95em; }
.product p { margin: 0; font-size: 0.9em; }
.btn { background: #2196f3; color: white; padding: 7px 15px; border: none; border-radius: 8px; cursor: pointer; margin-top: 8px; font-size: 0.9em; }
.btn:hover { background: #1976d2; }
.msg { margin-top: 5px; font-size: 0.85em; font-weight: bold; color: green; }

.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
.modal.show { display: block; }
.modal-content { background: #fff; margin: 15% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; position: relative; }
.modal input { width: 80%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; text-align: center; }
.close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5em; color: #aaa; cursor: pointer; }

/* NEW â€” Ù…ÙˆØ¯Ø§Ù„ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ØªØ¬ */
#previewModal .modal-content img {
    width: 100%;
    max-height: 220px;
    object-fit: contain;
    margin-bottom: 10px;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyByR2B-XISUw_PYh5EeIcbNQwwII0c6xZg",
  authDomain: "store-points-7d2f4.firebaseapp.com",
  databaseURL: "https://store-points-7d2f4-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "store-points-7d2f4",
  storageBucket: "store-points-7d2f4.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let users = {};
let products = {};
let currentProductId = null;
let currentProduct = null;

window.onload = () => {
  database.ref('users').once('value').then(snapshot => {
    users = snapshot.val() || {};
    loadProducts();
  });
};

function loadProducts() {
  database.ref('products').once('value').then(snapshot => {
    products = snapshot.val() || {};
    const storeDiv = document.querySelector('.store');
    storeDiv.innerHTML = '';
    for(let pid in products){
      const product = products[pid];
      const owner = users[product.ownerCode] || {};
      const purchaseCount = owner.purchaseCount && owner.purchaseCount[pid] ? owner.purchaseCount[pid] : 0;
      const div = document.createElement('div');
      div.className = 'product';
      div.innerHTML = `
        <img src="${product.image ? product.image : 'https://via.placeholder.com/150'}" alt="${product.name}" />
        <h3>${product.name}</h3>
        <p>Ø§Ù„Ø³Ø¹Ø±: ${product.price} Ù†Ù‚Ø·Ø©</p>

        <!-- ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
        <button class="btn" onclick="openPreview('${pid}')">Ø¹Ø±Ø¶</button>

        <div class="msg" id="msg${pid}">âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${purchaseCount}</div>
      `;
      storeDiv.appendChild(div);
    }
  });
}

/* NEW â€” ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
function openPreview(pid){
    const p = products[pid];
    currentProductId = pid;
    currentProduct = p;

    document.getElementById("previewImg").src = p.image || "https://via.placeholder.com/200";
    document.getElementById("previewName").innerText = p.name;
    document.getElementById("previewPrice").innerText = p.price;

    document.getElementById("previewModal").classList.add("show");
}

/* NEW â€” Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
function closePreview(){ document.getElementById("previewModal").classList.remove("show"); }

/* NEW â€” Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø´Ø±Ø§Ø¡ */
function continueToBuy(){
    closePreview();
    openPurchaseModal(currentProductId);
}

function openPurchaseModal(pid) {
  currentProductId = pid;
  currentProduct = products[pid];
  document.getElementById('modalUserCode').value = '';
  document.getElementById('modalUserPass').value = '';
  document.getElementById('modalMsg').innerText = '';
  document.getElementById('purchaseModal').classList.add('show');
}

function closePurchaseModal() { document.getElementById('purchaseModal').classList.remove('show'); }

function confirmPurchase(){
  const buyerCode = document.getElementById('modalUserCode').value.trim();
  const pass = document.getElementById('modalUserPass').value.trim();
  const msg = document.getElementById('modalMsg');

  if(!buyerCode||!pass){ msg.style.color='red'; msg.innerText='âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±!'; return; }
  const buyer = users[buyerCode];
  if(!buyer){ msg.style.color='red'; msg.innerText='âŒ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!'; return; }
  if(buyer.password!==pass){ msg.style.color='red'; msg.innerText='âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!'; return; }
  if(buyer.points<currentProduct.price){ msg.style.color='red'; msg.innerText='âŒ Ù†Ù‚Ø§Ø·Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠØ©!'; return; }

  const owner = users[currentProduct.ownerCode];
  if(!owner){ msg.style.color='red'; msg.innerText='âŒ Ø®Ø·Ø£: ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!'; return; }

  const newBuyerPoints = buyer.points - currentProduct.price;
  const newOwnerPoints = (owner.points || 0) + currentProduct.price;
  const newPurchaseCount = owner.purchaseCount||{};
  newPurchaseCount[currentProductId] = (newPurchaseCount[currentProductId]||0)+1;

  database.ref(`users/${currentProduct.ownerCode}`).update({
    points: newOwnerPoints,
    purchaseCount: newPurchaseCount
  }).then(()=> database.ref(`users/${buyerCode}/points`).set(newBuyerPoints))
  .then(()=>{
    buyer.points=newBuyerPoints;
    owner.points=newOwnerPoints;
    owner.purchaseCount=newPurchaseCount;
    document.getElementById(`msg${currentProductId}`).innerText=`âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ${owner.purchaseCount[currentProductId]}`;
    msg.style.color='green'; msg.innerText='âœ… ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!';
    sendToTelegram(buyerCode,buyer,currentProductId,currentProduct.price,newBuyerPoints);
    setTimeout(()=>{closePurchaseModal();},1500);
  }).catch(()=>{msg.style.color='red'; msg.innerText='âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯';});
}

function sendToTelegram(code,userObj,productId,price,remaining){
  const productName = products[productId].name;
  let message = `ğŸ›’ *Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯*\nğŸ“± *Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø®Ø§Øµ:* ${code}\nğŸ“¦ *Ø§Ù„Ù…Ù†ØªØ¬:* ${productName}\nğŸ’° *Ø§Ù„Ø³Ø¹Ø±:* ${price} Ù†Ù‚Ø·Ø©\nğŸ’³ *Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:* ${remaining} Ù†Ù‚Ø·Ø©`;
  let inlineKeyboard={inline_keyboard:[]};
  if(userObj.telegramId && userObj.telegramId!=="undefined") inlineKeyboard.inline_keyboard.push([{text:"ğŸ‘¤ ØªÙˆØ§ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…",url:`tg://user?id=${userObj.telegramId}`}]);
  else if(userObj.whatsappLink && userObj.whatsappLink!=="undefined") inlineKeyboard.inline_keyboard.push([{text:"ğŸ“± ØªÙˆØ§ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨",url:userObj.whatsappLink}]);
  fetch(`https://api.telegram.org/bot7823121427:AAFAQUIObZPEEhAK18nzWtem9oH7AIqF6ek/sendMessage`,{
    method:"POST",headers:{'Content-Type':'application/json'},
    body:JSON.stringify({chat_id:"-1001573316681",text:message,parse_mode:"Markdown",reply_markup:inlineKeyboard})
  });
}
</script>
</head>
<body>

<div class="store"></div>

<!-- NEW â€” Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
<div class="modal" id="previewModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closePreview()">âœ–</button>
    <img id="previewImg" src="">
    <h3 id="previewName"></h3>
    <p>Ø§Ù„Ø³Ø¹Ø±: <span id="previewPrice"></span> Ù†Ù‚Ø·Ø©</p>
    <button class="btn" onclick="continueToBuy()">Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø´Ø±Ø§Ø¡</button>
  </div>
</div>

<div class="modal" id="purchaseModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closePurchaseModal()">âœ–</button>
    <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡</h3>
    <input id="modalUserCode" placeholder="Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø®Ø§Øµ" />
    <input type="password" id="modalUserPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" />
    <div id="modalMsg" class="msg"></div>
    <button class="btn" onclick="confirmPurchase()">ØªØ£ÙƒÙŠØ¯</button>
  </div>
</div>
</body>
</html>